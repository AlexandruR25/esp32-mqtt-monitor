<!DOCTYPE html>
<html>
<head>
    <title>Monitor DHT ESP32</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; background-color: #f4f4f9; }
        .data-container { display: inline-block; padding: 20px; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #333; }
        .value { font-size: 3em; font-weight: bold; color: #007bff; margin-top: 10px; }
        .label { font-size: 1.2em; color: #555; }
        .status { margin-top: 10px; font-weight: bold; }
        .status.online { color: green; }
        .status.offline { color: red; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
</head>
<body>

    <h1>Monitorizare Climă ESP32-C3</h1>
    <div class="data-container">
        <div class="label">Temperatura:</div>
        <div id="temperatura" class="value">--.-- °C</div>

        <div class="label" style="margin-top: 15px;">Umiditatea:</div>
        <div id="umiditate" class="value">--.-- %</div>
    </div>
    
    <div class="status">
        Status Conexiune MQTT: <span id="mqtt-status">Deconectat</span>
    </div>
    
    <div class="status">
        Comunicare Placă: <span id="data-status" class="status offline">Așteaptă date...</span>
    </div>

    <script>
        // --- ⚠️ DATELE TALE DE CONEXIUNE (MODIFICĂ!) ⚠️ ---
        const MQTT_HOST = "45529ea6f341410aa5a4fd3d6d0509b8.s1.eu.hivemq.cloud"; 
        const MQTT_PORT = 8884; // Portul pentru MQTT over WebSockets (WSS/SSL) pe HiveMQ
        const MQTT_USER = "esp_1";
        const MQTT_PASS = "Oananebunamea12!";
        const MQTT_TOPIC = "esp/device1/data";
        
        // --- Constante Stare ---
        const DATA_TIMEOUT = 15000; // 15 secunde (Placa trimite la fiecare 5s, deci 15s este un prag sigur)
        let lastMessageTime = Date.now();
        let timeoutTimer;

        // --- Inițializare ---
        const client = new Paho.MQTT.Client(
            MQTT_HOST, 
            MQTT_PORT, 
            "/mqtt", 
            "web_client_" + parseInt(Math.random() * 100, 10)
        );

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;
        
        // Încearcă să încarci ultima valoare din memorie la pornire
        loadLastValues();
        
        connect();
        
        // Setează timer-ul de verificare a stării de date
        checkDataStatus();

        function connect() {
            document.getElementById("mqtt-status").innerText = "Se conectează...";
            client.connect({
                userName: MQTT_USER,
                password: MQTT_PASS,
                useSSL: true, 
                onSuccess: onConnect,
                onFailure: onFailure
            });
        }

        function onConnect() {
            document.getElementById("mqtt-status").innerText = "Conectat la Broker (WSS)";
            client.subscribe(MQTT_TOPIC);
            console.log("Abonat la topic: " + MQTT_TOPIC);
        }

        function onFailure(responseObject) {
            document.getElementById("mqtt-status").innerText = "Eroare: " + responseObject.errorMessage;
            document.getElementById("data-status").innerText = "Deconectat de la broker";
            document.getElementById("data-status").className = "status offline";
            console.log("Eroare de conexiune: " + responseObject.errorMessage);
            setTimeout(connect, 5000); 
        }

        function onConnectionLost(responseObject) {
            document.getElementById("mqtt-status").innerText = "Conexiune Pierdută!";
            document.getElementById("data-status").innerText = "Deconectat de la broker";
            document.getElementById("data-status").className = "status offline";
            if (responseObject.errorCode !== 0) {
                console.log("onConnectionLost:" + responseObject.errorMessage);
            }
            setTimeout(connect, 5000);
        }

        function onMessageArrived(message) {
            try {
                const payload = message.payloadString;
                const data = JSON.parse(payload);
                
                // Actualizează timpul ultimului mesaj
                lastMessageTime = Date.now();
                
                // 1. Memorarea și Afișarea Valorilor
                const temp = data.temp.toFixed(2);
                const humidity = data.humidity.toFixed(2);
                
                document.getElementById("temperatura").innerText = temp + " °C";
                document.getElementById("umiditate").innerText = humidity + " %";
                
                // Salvează valorile în memoria locală (pentru reîncărcarea paginii)
                localStorage.setItem('last_temp', temp);
                localStorage.setItem('last_humidity', humidity);

                console.log("Date primite: " + payload);

            } catch (e) {
                console.error("Eroare la parsarea JSON: " + e);
            }
        }
        
        // 2. Funcție de Verificare a Stării de Comunicare
        function checkDataStatus() {
            const now = Date.now();
            const elapsed = now - lastMessageTime;

            const dataStatusElement = document.getElementById("data-status");

            if (client.isConnected() && elapsed < DATA_TIMEOUT) {
                // Mesaj primit recent
                dataStatusElement.innerText = "Comunică în timp real";
                dataStatusElement.className = "status online";
            } else if (client.isConnected()) {
                // Conectat la broker, dar nu s-au primit date (placa e oprită/blocată)
                dataStatusElement.innerText = "Nu comunică (Timeout)";
                dataStatusElement.className = "status offline";
            } else {
                // Nu e conectat la broker
                dataStatusElement.innerText = "Așteaptă conexiunea la broker";
                dataStatusElement.className = "status offline";
            }

            // Setează funcția să ruleze din nou după 5 secunde
            timeoutTimer = setTimeout(checkDataStatus, 5000);
        }
        
        // Funcție pentru a încărca ultima valoare salvată din browser
        function loadLastValues() {
            const lastTemp = localStorage.getItem('last_temp');
            const lastHumidity = localStorage.getItem('last_humidity');
            
            if (lastTemp) {
                document.getElementById("temperatura").innerText = lastTemp + " °C";
            }
            if (lastHumidity) {
                document.getElementById("umiditate").innerText = lastHumidity + " %";
            }
        }
    </script>
</body>
</html>
